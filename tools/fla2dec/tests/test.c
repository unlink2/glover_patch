#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <string.h>
#include <errno.h>
#include <ctype.h>
#include <stdlib.h>
#include <stdio.h>

#include "../src/fla2.h"

static void test_dec_fla2(void **state) {
    unsigned char input[112] = {
        0x46, 0x4C, 0x41, 0x32, 0xDC, 0x85, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x37, 0x61, 0x9E, 0x3B, 0x2A, 0xA2, 0x01, 0x08, 0x02, 0x01, 0x04, 0x00,
        0x00, 0x10, 0x01, 0x02, 0x04, 0x88, 0x01, 0x02, 0x00, 0x00, 0xC8, 0x03,
        0x10, 0x00, 0x00, 0x24, 0x80, 0x01, 0x04, 0xA8, 0x22, 0x22, 0x44, 0x44,
        0x33, 0x33, 0x3F, 0x11, 0x11, 0x0F, 0x08, 0x05, 0x08, 0x05, 0x2C, 0x0F,
        0x01, 0x0F, 0x01, 0x0F, 0x01, 0xE0, 0x0F, 0x01, 0x0F, 0x01, 0x06, 0x01,
        0xFF, 0xFF, 0xC8, 0x01, 0xFF, 0x00, 0xC1, 0x0E, 0x81, 0x00, 0x29, 0x00,
        0x01, 0xC6, 0x41, 0x71, 0x0F, 0x02, 0x71, 0xD2, 0x2B, 0xC3, 0x44, 0x0F,
        0xC8, 0xBF, 0x0D, 0xC8, 0x11, 0x01, 0x01, 0x02, 0x0D, 0x0F, 0x08, 0x0F,
        0x08, 0x0F, 0x08, 0x00
    };

    unsigned char expected[113] = {
        0x00, 0x00, 0x00, 0x37, 0x61, 0x9E, 0x3B, 0x2A, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00, 0x04, 0x00, 0x04,
        0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24,
        0x00, 0x00, 0x00, 0xA8, 0x22, 0x22, 0x44, 0x44, 0x33, 0x33, 0x11, 0x11,
        0x22, 0x22, 0x44, 0x44, 0x33, 0x33, 0x11, 0x11, 0x22, 0x22, 0x44, 0x44,
        0x33, 0x33, 0x11, 0x11, 0x22, 0x22, 0x44, 0x44, 0x33, 0x33, 0x11, 0x11,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00
    };



    unsigned char *poutput = malloc(0x1000000 * sizeof(char));

    int csize = 0;
    int poutput_pos = dec_fla2(input+8, &csize, 112, poutput);

    assert_int_equal(poutput_pos, 0x71);
    assert_int_equal(csize, 0x37);

    for (int i = 0; i < poutput_pos; i++) {
        assert_int_equal(expected[i], poutput[i]);
    }

    free(poutput);
}

int main() {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test(test_dec_fla2)
    };

    return cmocka_run_group_tests(tests, NULL, NULL);
}
